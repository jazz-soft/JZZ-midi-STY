<!DOCTYPE html>
<html lang=en>
<head>
<title>Style View</title>
<script src="node_modules/jzz/javascript/JZZ.js"></script>
<script src="node_modules/jzz-gui-select/javascript/JZZ.gui.Select.js"></script>
<script src="node_modules/jzz-synth-tiny/javascript/JZZ.synth.Tiny.js"></script>
<script src="node_modules/jzz-midi-smf/javascript/JZZ.midi.SMF.js"></script>
<script src="javascript/JZZ.midi.STY.js"></script>
<style>
.knob { width:1em; height:1em; display:inline-block; margin-left:.2em; margin-right:.2em; }
.knobb { width:1em; height:1em; display:inline-block; margin-left:.2em; margin-right:.2em; text-align:center; background-color:#ddd; line-height:1em; vertical-align:middle; margin=0; }
.title { min-width:8em; display:inline-block; margin-right:.2em; font-weight:bold; }
.drop { margin-left:1.5em; }
.hide { display:none; }
</style>
</head>

<body>

<h1>Style View</h1>
<p id=panel>Please enable JavaScript!</p>

<script>
var panel = document.getElementById('panel');
panel.innerHTML = 'Please run <tt style="background-color:#bbf;"><b>npm install</b></tt> to enable this test.';
JZZ.synth.Tiny.register('Web Audio');
var SMF = JZZ.MIDI.SMF;
var STY = JZZ.MIDI.STY;
panel.innerHTML = 'Midi-Out: <select id="midi_out"></select> File: ';
var midi_out = JZZ.gui.SelectMidiOut({ at: 'midi_out' });
midi_out.select();
var input = document.createElement('input');
input.type = 'file';
input.accept = '.sty,.sst,.prs';
input.addEventListener("change", load_file);
panel.appendChild(input);
panel.appendChild(document.createElement('hr'));
var display = document.createElement('div');
panel.appendChild(display);
var gui;

function load_file() {
  if (window.FileReader) {
    var reader = new FileReader();
    reader.onload = function(e) { load_sty(e.target.result); };
    reader.readAsArrayBuffer(input.files[0]);
  }
  else alert('File API is not supported in this browser.');
}
function load_sty(data) {
  try {
    var sty = new STY(data);
    display_sty(sty);
  }
  catch (err) { alert(err.message); }
}
function display_sty(sty) {
  display.innerHTML = '';
  gui = new Cell(display, 0, 'Style', sty.name, sty, populate);
  gui.expand();
}

function Cell(parent, type, title, text, ref, pop) {
  var self = this;
  this.populate = pop;
  this.div = document.createElement('div');
  var knob = square(type);//document.createElement('span');
  if (type == 1) {
    knob.innerHTML = '+';
    knob.addEventListener('click', function() {
      if (self.exp) {
        self.collapse();
        knob.innerHTML = '+';
      }
      else {
        self.expand();
        knob.innerHTML = '-';
      }
      self.exp = !self.exp;
    });
  }
  this.div.appendChild(knob);
  var span = document.createElement('span');
  span.className = 'title';
  span.innerHTML = title;
  this.div.appendChild(span);
  span = document.createElement('span');
  span.innerHTML = text;
  this.div.appendChild(span);
  this.ref = ref;
  parent.appendChild(this.div);
}
Cell.prototype.expand = function() {
  if (!this.more) {
    this.more = document.createElement('div');
    this.more.className = 'drop';
    if (this.populate) this.populate();
    this.div.appendChild(this.more);
  }
  this.more.classList.remove('hide');
}
Cell.prototype.collapse = function() {
  this.more.classList.add('hide');
}
var svg_play = '<svg fill="#555" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"/><path d="M0 0h24v24H0z" fill="none"/></svg>';
var svg_stop = '<svg fill="#555" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 6h12v12H6z"/></svg>';
function MidiCell(parent, title, smf) {
  var a, p, q;
  var cell = new Cell(parent, 0, title, '');
  a = document.createElement('a');
  a.href = 'data:audio/midi;base64,' + JZZ.lib.toBase64(smf.dump());
  a.download = title.split(' ').join('-') + '.mid';
  q = square(1);
  q.innerHTML = '<svg fill="#555" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/><path fill="none" d="M0 0h24v24H0z"/></svg>';
  a.appendChild(q);
  a.title = 'export';
  cell.div.appendChild(a);
  p = square(1);
  p.innerHTML = svg_play;
  p.title = 'play';
  cell.div.appendChild(p);

  var player;
  var playing = false;
  p.addEventListener('click', function() {
    if (playing) {
      if (player) {
        player.stop();
        player.onEnd();
      }
    }
    else {
      if (!player) {
        player = smf.player();
        player.connect(midi_out);
        player.onEnd = function() {
          playing = false;
          p.innerHTML = svg_play;
          p.title = 'play';
        };
      }
      playing = true;
      p.innerHTML = svg_stop;
      p.title = 'stop';
      player.play();
    }
  });

  return cell;
}
function square(t, s) {
  sq = document.createElement('span');
  sq.className = t ? 'knobb' : 'knob';
  if (s) sq.innerHTML = s;
  return sq;
}
function populate() {
  this.cells = [];
  this.cells.push(new Cell(this.more, 1, 'MTrk', [this.ref.tsig || '', this.ref.bpm ? this.ref.bpm + ' bpm' : '' ].join('; ').trim(), this.ref, populate_mtrk));
  if (this.ref.casm) this.cells.push(new Cell(this.more, 1, 'CASM', '', this.ref, populate_casm));
  if (this.ref.otsc) this.cells.push(new Cell(this.more, 1, 'OTSc', '', this.ref, populate_otsc));
  if (this.ref.fnrc) this.cells.push(new Cell(this.more, 1, 'FNRc', '', this.ref, populate_fnrc));
  if (this.ref.mhhd) this.cells.push(new Cell(this.more, 0, 'MHhd', 'not supported'));
}
function populate_mtrk() {
  var i, j, t, smf, trk;
  this.cells = [];
  for (i = 0; i < this.ref.mrk.length; i++) {
    t = this.ref.trk[this.ref.mrk[i]];
    smf = new JZZ.MIDI.SMF(0, this.ref.ppqn);
    trk = new JZZ.MIDI.SMF.MTrk();
    if (this.ref.tempo) trk.add(0, JZZ.MIDI.smfTempo(this.ref.tempo));
    for (j = 0; j < t.length; j++) trk.add(t[j].tt, t[j]);
    smf.push(trk);
    this.cells.push(new MidiCell(this.more, this.ref.mrk[i], smf));
  }
}
function populate_casm() {
  var i, j, cell;
  this.cells = [];
  for (i = 0; i < this.ref.casm.length; i++) {
    this.cells.push(new Cell(this.more, 1, this.ref.casm[i].sdec, '', this.ref.casm[i], populate_ctab));
  }
}
function populate_ctab() {
  var i;
  this.cells = [];
  if (this.ref.ctab) for (i = 0; i < this.ref.ctab.length; i++) {
    this.cells.push(new Cell(this.more, 0, 'Ctab', '', this.ref));
  }
  if (this.ref.ctb2) for (i = 0; i < this.ref.ctb2.length; i++) {
    this.cells.push(new Cell(this.more, 0, 'Ctb2', '', this.ref));
  }
  if (this.ref.cntt) for (i = 0; i < this.ref.cntt.length; i++) {
    this.cells.push(new Cell(this.more, 0, 'Cntt', '', this.ref));
  }
}
function populate_otsc() {
  var i, smf;
  this.cells = [];
  for (i = 0; i < this.ref.otsc.length; i++) {
    smf = new JZZ.MIDI.SMF();
    smf.push(this.ref.otsc[i]);
    this.cells.push(new MidiCell(this.more, 'MTrk ' + (i + 1), smf));
  }
}
function populate_fnrc() {
  var i, x, a;
  this.cells = [];
  for (i = 0; i < this.ref.fnrc.length; i++) {
    x = this.ref.fnrc[i];
    a = [x.tsig.join('/'), x.bpm + ' bpm'];
    if (x.genre) a.push('genre: ' + x.genre);
    if (x.kwd1) a.push('keywords: ' + x.kwd1);
    if (x.kwd2) a.push('keywords: ' + x.kwd2);
    this.cells.push(new Cell(this.more, 0, x.name + '&nbsp;&nbsp;', a.join('; ')));
  }
}
</script>

</body>
</html>
